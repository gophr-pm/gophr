#! /bin/bash

# Constants
IMAGE_NAME="gophr-api"
DOCKER_MACHINE_NAME="gophr-staging"

# Get base directories
bin_dir="$( cd "$( dirname "${BASH_SOURCE[0]}" )" && pwd )"
image_dir="$( dirname $bin_dir )"
bump_script="$( dirname $( dirname $( dirname $( dirname $bin_dir ) ) ) )/bin/util/bump"

# Color variables
esc_seq="\x1b["
no_color=$esc_seq"39;49;00m"
green_color=$esc_seq"32;01m"

# Start the docker machine
echo "Starting the docker machine..."
docker-machine start $DOCKER_MACHINE_NAME &>/dev/null
echo -e "${green_color}✓ Docker machine started successfully!${no_color}"

# Connect to the docker machine
echo "Connecting to the docker machine..."
eval $(docker-machine env "$DOCKER_MACHINE_NAME")
echo -e "${green_color}✓ Connected to the docker machine successfully!${no_color}"

echo -e "\nResolving new image version..." \
&& (cd $image_dir && $bump_script) \
&& IMAGE_TAG="$(cat ${image_dir}/Versionfile)" \
&& echo "Building '$IMAGE_NAME:$IMAGE_TAG' image..." \
&& docker build --rm -t "$IMAGE_NAME:$IMAGE_TAG" "$image_dir" \
&& docker tag "$IMAGE_NAME:$IMAGE_TAG" "$IMAGE_NAME:latest" \
&& echo -e "${green_color}✓ The '$IMAGE_NAME:$IMAGE_TAG' image was built successfully!${no_color}"
